import{a as y}from"./chunk-XYMJPSQV.js";import{a as $,e as A,i as B}from"./chunk-PK7LRR4S.js";import{D as T,Fb as S,Ha as g,L as I,N as D,Q as d,V as f,a as x,b as E,d as C,g as k,h as j,j as b,ka as U,m as N,q as _,x as w,y as R}from"./chunk-25PO6U34.js";import{a as W,b as O}from"./chunk-3HT42XJM.js";var m=class n{constructor(t){this.httpService=t;this.chats=g([])}loadAll(){return this.httpService.request("GET","/api/chat/",{body:{email:"test@test.org"}}).pipe(D(t=>this.chats.set(t)))}create(t){return this.httpService.post("/api/chat/",{name:t})}get(t){return this.httpService.get(`/api/chat/${t}`).pipe(R(()=>N(null)))}delete(t){return this.httpService.delete(`/api/chat/${t}`)}update(t,e){return this.httpService.put(`/api/chat/${t}`,{name:e})}static{this.\u0275fac=function(e){return new(e||n)(f($))}}static{this.\u0275prov=d({token:n,factory:n.\u0275fac})}};var H={apiUrl:"http://127.0.0.1:8888",wsApiUrl:"ws://127.0.0.1:8888"};var G={url:"",deserializer:n=>JSON.parse(n.data),serializer:n=>JSON.stringify(n)},q="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",u=class n extends j{constructor(t,e){if(super(),this._socket=null,t instanceof C)this.destination=e,this.source=t;else{let r=this._config=Object.assign({},G);if(this._output=new k,typeof t=="string")r.url=t;else for(let s in t)t.hasOwnProperty(s)&&(r[s]=t[s]);if(!r.WebSocketCtor&&WebSocket)r.WebSocketCtor=WebSocket;else if(!r.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new b}}lift(t){let e=new n(this._config,this.destination);return e.operator=t,e.source=this,e}_resetState(){this._socket=null,this.source||(this.destination=new b),this._output=new k}multiplex(t,e,r){let s=this;return new C(o=>{try{s.next(t())}catch(c){o.error(c)}let i=s.subscribe({next:c=>{try{r(c)&&o.next(c)}catch(a){o.error(a)}},error:c=>o.error(c),complete:()=>o.complete()});return()=>{try{s.next(e())}catch(c){o.error(c)}i.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:t,protocol:e,url:r,binaryType:s}=this._config,o=this._output,i=null;try{i=e?new t(r,e):new t(r),this._socket=i,s&&(this._socket.binaryType=s)}catch(a){o.error(a);return}let c=new x(()=>{this._socket=null,i&&i.readyState===1&&i.close()});i.onopen=a=>{let{_socket:l}=this;if(!l){i.close(),this._resetState();return}let{openObserver:M}=this._config;M&&M.next(a);let v=this.destination;this.destination=E.create(h=>{if(i.readyState===1)try{let{serializer:p}=this._config;i.send(p(h))}catch(p){this.destination.error(p)}},h=>{let{closingObserver:p}=this._config;p&&p.next(void 0),h&&h.code?i.close(h.code,h.reason):o.error(new TypeError(q)),this._resetState()},()=>{let{closingObserver:h}=this._config;h&&h.next(void 0),i.close(),this._resetState()}),v&&v instanceof b&&c.add(v.subscribe(this.destination))},i.onerror=a=>{this._resetState(),o.error(a)},i.onclose=a=>{i===this._socket&&this._resetState();let{closeObserver:l}=this._config;l&&l.next(a),a.wasClean?o.complete():o.error(a)},i.onmessage=a=>{try{let{deserializer:l}=this._config;o.next(l(a))}catch(l){o.error(l)}}}_subscribe(t){let{source:e}=this;return e?e.subscribe(t):(this._socket||this._connectSocket(),this._output.subscribe(t),t.add(()=>{let{_socket:r}=this;this._output.observers.length===0&&(r&&(r.readyState===1||r.readyState===0)&&r.close(),this._resetState())}),t)}unsubscribe(){let{_socket:t}=this;t&&(t.readyState===1||t.readyState===0)&&t.close(),this._resetState(),super.unsubscribe()}};var K=(e=>(e.USER="user",e.AGENT="agent",e))(K||{}),J=class n{constructor(t,e,r){this.router=t;this.chatsService=e;this.destroyRef=r;this.activeChatId=g("");this.activeChatOldMessages=g([]);this.activeChatNewMessages=g([]);this.activeChatMessages=S(()=>[...this.activeChatOldMessages(),...this.activeChatNewMessages()]);this.gotNewMessage=S(()=>!!this.activeChatNewMessages().length);this.waitingBotResponse=S(()=>this.activeChatMessages().at(-1)?.role==="user");this.#e={url:`${H.wsApiUrl}/chat/ws`};this.#s=t=>({next:()=>{console.log(`WebSocket ${t} DISCONNECTED!`)}});this.#i=t=>({next:()=>{console.log(`WebSocket ${t} CONNECTED!`)}});this.router.events.pipe(w(s=>s instanceof A),_(({urlAfterRedirects:s})=>s.split("/").pop()),w(s=>!!s&&s!=="chats"),I(s=>this.chatsService.get(s)),T(),y()).subscribe(s=>{this.disconnect(),s&&(this.connect(s.id),s.messages&&this.activeChatOldMessages.set(s.messages))})}#t;#e;#s;#i;connect(t){this.activeChatId.set(t);let e=O(W({},this.#e),{url:`${this.#e.url}/${t}`,closeObserver:this.#s(t),openObserver:this.#i(t)});this.#t=new u(e),this.initWebsocketMessageHandler()}disconnect(){this.#t&&(this.#t.unsubscribe(),this.#t.complete(),this.activeChatId.set(""),this.activeChatOldMessages.set([]),this.activeChatNewMessages.set([]))}send(t){this.#t&&this.#t.next({content:t})}initWebsocketMessageHandler(){this.#t&&this.#t.pipe(_(t=>JSON.parse(t)),y(this.destroyRef)).subscribe(t=>{this.activeChatNewMessages.update(e=>[...e,t])})}static{this.\u0275fac=function(e){return new(e||n)(f(B),f(m),f(U))}}static{this.\u0275prov=d({token:n,factory:n.\u0275fac})}};export{m as a,K as b,J as c};
/**i18n:ed7ec225acdd9c4f0fa7847d53fc67c2e1160b32a59af7292008029acf8bcf9e*/
